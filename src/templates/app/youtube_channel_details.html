{% extends "base.html" %}
{% load app_tags %}
{% load humanize %}

{% block title %}
  {{ media.title }} (YouTube Channel) - Yamtrack
{% endblock title %}

{% block content %}
  {# Top section #}
  <div class="flex flex-col md:flex-row gap-8 md:gap-10 mb-12 md:mb-8">
    <div class="w-full md:w-1/4 max-w-[250px] mx-auto md:mx-0">
      <img alt="{{ media.title }}"
           class="w-full rounded-lg shadow-lg bg-[#2a2f35] object-cover"
           src="{{ media.image }}">

      <div x-data="{ trackOpen: false }">
        <button class="mt-4 p-3 rounded-lg w-full flex items-center text-white transition duration-300 cursor-pointer {% if user_medias %}bg-red-600 hover:bg-red-700{% else %}bg-gray-600 hover:bg-gray-700{% endif %}"
                hx-get="{% media_view_url 'track_modal' media %}"
                hx-vals='{"return_url": "{{ request.get_full_path|urlencode }}", "instance_id": "{{ current_instance.id }}"}'
                hx-target="#{% component_id 'track' media current_instance.id %}"
                hx-trigger="click"
                @click="trackOpen = true">
          <div class="flex-1 text-center font-medium">
            {% if user_medias %}
              {{ current_instance.status|media_status_readable }}
            {% else %}
              Add to tracker
            {% endif %}
          </div>

          <div class="h-5 mx-2 border-l border-white/30"></div>
          <svg xmlns="http://www.w3.org/2000/svg"
               width="24"
               height="24"
               viewBox="0 0 24 24"
               fill="none"
               stroke="currentColor"
               stroke-width="2"
               stroke-linecap="round"
               stroke-linejoin="round"
               class="w-5 h-5 flex-shrink-0">
            <path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.375 2.625a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4Z"></path>
          </svg>
        </button>

        {# Track Modal #}
        <div x-show="trackOpen"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform scale-95"
             x-transition:enter-end="opacity-100 transform scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 transform scale-100"
             x-transition:leave-end="opacity-0 transform scale-95"
             id="{% component_id 'track' media current_instance.id %}"
             @click.away="trackOpen = false">
        </div>
      </div>
    </div>

    <div class="flex-1">
      <h1 class="text-3xl font-bold mb-4 text-center md:text-start">
        {{ media.title }}
        <span class="text-red-500 text-sm font-normal ml-2">
          <i class="fab fa-youtube"></i> YouTube Channel
        </span>
      </h1>

      {# Channel metadata #}
      <div class="flex flex-wrap gap-4 mb-4 text-sm text-gray-400">
        {% if media.subscriber_count %}
          <span>{{ media.subscriber_count|intcomma }} subscribers</span>
        {% endif %}
        {% if media.video_count %}
          <span>{{ media.video_count|intcomma }} videos</span>
        {% endif %}
        {% if media.view_count %}
          <span>{{ media.view_count|intcomma }} total views</span>
        {% endif %}
      </div>

      {# Description #}
      {% if media.synopsis %}
        <div class="mb-6">
          <div x-data="{ isExpanded: false, isClamped: false, checkClamp() { const element = this.$refs.synopsisText; this.isClamped = element.scrollHeight > element.clientHeight; } }"
               x-init="$nextTick(() => checkClamp())">
            <p x-ref="synopsisText"
               :class="isExpanded ? '' : 'line-clamp-5'"
               class="text-gray-300 text-pretty">{{ media.synopsis|linebreaksbr|safe }}</p>
            <button x-show="isClamped"
                    @click="isExpanded = !isExpanded"
                    class="text-red-400 hover:text-red-300 text-sm mt-2 focus:outline-none transition-colors cursor-pointer">
              <span x-text="isExpanded ? 'Show less' : 'Read more'"></span>
            </button>
          </div>
        </div>
      {% endif %}

      {% if current_instance.notes %}
        <div class="mb-6">
          <div class="border-t border-gray-700 pt-4">
            <div class="bg-[#2a2f35] p-4 rounded-lg">
              <h3 class="text-sm font-semibold text-gray-200 mb-2">Your Notes</h3>
              <p class="text-gray-300 text-sm">{{ current_instance.notes|linebreaksbr|safe }}</p>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  {# Videos Section #}
  <div class="mb-8">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
      <h2 class="text-2xl font-bold mb-4 md:mb-0">
        Videos
        {% if media.videos %}
          <span class="text-gray-400 text-sm font-normal ml-2">
            ({{ media.videos|length }} {% if current_year != "all" %}from {{ current_year }}{% endif %})
          </span>
        {% endif %}
      </h2>

      <div class="flex flex-col sm:flex-row gap-2">
        {# Year Filter #}
        <div class="relative" x-data="{ yearOpen: false }">
          <button @click="yearOpen = !yearOpen"
                  class="px-4 py-2 bg-[#2a2f35] text-white rounded-md hover:bg-gray-600 transition-colors cursor-pointer flex items-center justify-between min-w-[120px]">
            <span>{{ current_year|default:"All Years" }}</span>
            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          
          <div x-show="yearOpen"
               @click.away="yearOpen = false"
               x-transition:enter="transition ease-out duration-100"
               x-transition:enter-start="opacity-0 scale-95"
               x-transition:enter-end="opacity-100 scale-100"
               x-transition:leave="transition ease-in duration-75"
               x-transition:leave-start="opacity-100 scale-100"
               x-transition:leave-end="opacity-0 scale-95"
               class="absolute right-0 mt-2 w-40 bg-[#2a2f35] rounded-md shadow-lg z-10">
            <div class="max-h-60 overflow-y-auto">
              <a href="?{% url_replace year='all' %}"
                 class="block px-4 py-2 text-sm hover:bg-gray-600 transition-colors cursor-pointer {% if current_year == 'all' %}bg-gray-700{% endif %}">
                All Years
              </a>
              {% for year in available_years %}
                <a href="?{% url_replace year=year %}"
                   class="block px-4 py-2 text-sm hover:bg-gray-600 transition-colors cursor-pointer {% if current_year|add:0 == year %}bg-gray-700{% endif %}">
                  {{ year }}
                </a>
              {% endfor %}
            </div>
          </div>
        </div>

        {# Status Filter #}
        <div class="relative" x-data="{ filterOpen: false }">
          <button @click="filterOpen = !filterOpen"
                  class="px-4 py-2 bg-[#2a2f35] text-white rounded-md hover:bg-gray-600 transition-colors cursor-pointer flex items-center justify-between min-w-[120px]">
            <span>
              {% if current_filter == "watched" %}Watched
              {% elif current_filter == "unwatched" %}Unwatched
              {% else %}All Videos{% endif %}
            </span>
            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          
          <div x-show="filterOpen"
               @click.away="filterOpen = false"
               x-transition:enter="transition ease-out duration-100"
               x-transition:enter-start="opacity-0 scale-95"
               x-transition:enter-end="opacity-100 scale-100"
               x-transition:leave="transition ease-in duration-75"
               x-transition:leave-start="opacity-100 scale-100"
               x-transition:leave-end="opacity-0 scale-95"
               class="absolute right-0 mt-2 w-32 bg-[#2a2f35] rounded-md shadow-lg z-10">
            <a href="?{% url_replace filter='all' %}"
               class="block px-4 py-2 text-sm hover:bg-gray-600 transition-colors cursor-pointer {% if current_filter == 'all' %}bg-gray-700{% endif %}">
              All Videos
            </a>
            <a href="?{% url_replace filter='unwatched' %}"
               class="block px-4 py-2 text-sm hover:bg-gray-600 transition-colors cursor-pointer {% if current_filter == 'unwatched' %}bg-gray-700{% endif %}">
              Unwatched
            </a>
            <a href="?{% url_replace filter='watched' %}"
               class="block px-4 py-2 text-sm hover:bg-gray-600 transition-colors cursor-pointer {% if current_filter == 'watched' %}bg-gray-700{% endif %}">
              Watched
            </a>
          </div>
        </div>

        {# Sort Order #}
        <div class="relative" x-data="{ sortOpen: false }">
          <button @click="sortOpen = !sortOpen"
                  class="px-4 py-2 bg-[#2a2f35] text-white rounded-md hover:bg-gray-600 transition-colors cursor-pointer flex items-center justify-between min-w-[120px]">
            <span>
              {% if current_sort == "asc" %}Oldest First
              {% else %}Newest First{% endif %}
            </span>
            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          
          <div x-show="sortOpen"
               @click.away="sortOpen = false"
               x-transition:enter="transition ease-out duration-100"
               x-transition:enter-start="opacity-0 scale-95"
               x-transition:enter-end="opacity-100 scale-100"
               x-transition:leave="transition ease-in duration-75"
               x-transition:leave-start="opacity-100 scale-100"
               x-transition:leave-end="opacity-0 scale-95"
               class="absolute right-0 mt-2 w-32 bg-[#2a2f35] rounded-md shadow-lg z-10">
            <a href="?{% url_replace sort='desc' %}"
               class="block px-4 py-2 text-sm hover:bg-gray-600 transition-colors cursor-pointer {% if current_sort == 'desc' %}bg-gray-700{% endif %}">
              Newest First
            </a>
            <a href="?{% url_replace sort='asc' %}"
               class="block px-4 py-2 text-sm hover:bg-gray-600 transition-colors cursor-pointer {% if current_sort == 'asc' %}bg-gray-700{% endif %}">
              Oldest First
            </a>
          </div>
        </div>
      </div>
    </div>

    {# Videos List #}
    {% if media.videos %}
      <div class="grid gap-4">
        {% for video in media.videos %}
          <div class="bg-[#2a2f35] rounded-lg p-4 hover:bg-gray-600 transition-colors" data-video-card>
            <div class="flex gap-4">
              {# Video Thumbnail #}
              <div class="flex-shrink-0">
                {% if video.thumbnail %}
                  <img src="{{ video.thumbnail }}" 
                       alt="{{ video.title }}"
                       class="w-32 h-20 object-cover rounded bg-gray-700">
                {% else %}
                  <div class="w-32 h-20 bg-gray-700 rounded flex items-center justify-center">
                    <i class="fab fa-youtube text-red-500 text-2xl"></i>
                  </div>
                {% endif %}
              </div>

              {# Video Info #}
              <div class="flex-1">
                <h3 class="font-semibold mb-2 line-clamp-2">{{ video.title }}</h3>
                
                <div class="flex flex-wrap gap-4 text-sm text-gray-400 mb-2">
                  {% if video.published_date %}
                    <span>{{ video.published_date|date:"M j, Y" }}</span>
                  {% endif %}
                  {% if video.duration %}
                    <span>{{ video.duration }}</span>
                  {% endif %}
                  {% if video.view_count %}
                    <span>{{ video.view_count|intcomma }} views</span>
                  {% endif %}
                </div>

                {% if video.description %}
                  <p class="text-gray-300 text-sm line-clamp-2">{{ video.description }}</p>
                {% endif %}
              </div>

              {# Watch Status #}
              {# Watch Status and Delete #}
              <div class="flex-shrink-0 flex items-center gap-2">
                {% if video.history %}
                  <div class="bg-green-600 text-white px-3 py-1 rounded-full text-sm">
                    <i class="fas fa-check mr-1"></i>Watched
                  </div>
                {% else %}
                  <button class="bg-gray-600 hover:bg-gray-500 text-white px-3 py-1 rounded-full text-sm transition-colors cursor-pointer"
                          hx-post="{% url 'mark_episode_watched' %}"
                          hx-vals='{"video_id": "{{ video.id }}", "media_id": "{{ media.media_id }}"}'>
                    Mark Watched
                  </button>
                {% endif %}
                
                {# Delete Video Button #}
                <div x-data="{ confirmDelete: false }">
                  <button @click="confirmDelete = true"
                          class="p-2.5 bg-red-600 text-white rounded-full hover:bg-red-500 hover:scale-110 hover:shadow-[0_0_15px_rgba(220,38,38,0.5)] transition-all duration-200 cursor-pointer"
                          title="Delete video">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         width="16"
                         height="16"
                         viewBox="0 0 24 24"
                         fill="none"
                         stroke="currentColor"
                         stroke-width="2"
                         stroke-linecap="round"
                         stroke-linejoin="round">
                      <path d="M3 6h18"></path>
                      <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                      <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                      <line x1="10" x2="10" y1="11" y2="17"></line>
                      <line x1="14" x2="14" y1="11" y2="17"></line>
                    </svg>
                  </button>

                  {# Confirmation Dialog #}
                  <div x-show="confirmDelete"
                       x-cloak
                       @click.away="confirmDelete = false"
                       class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
                       style="display: none;">
                    <div class="bg-[#1e2328] rounded-lg p-6 max-w-md w-full mx-4 shadow-xl"
                         @click.stop>
                      <h3 class="text-lg font-semibold mb-4">Delete Video?</h3>
                      <p class="text-gray-300 mb-6">Are you sure you want to delete "{{ video.title }}"? This action cannot be undone.</p>
                      <div class="flex gap-3 justify-end">
                        <button @click="confirmDelete = false"
                                class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-md transition-colors cursor-pointer">
                          Cancel
                        </button>
                        <button hx-delete="{% url 'delete_youtube_video' video.id %}"
                                hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                                hx-target="closest [data-video-card]"
                                hx-swap="outerHTML swap:0.5s"
                                @click="confirmDelete = false"
                                class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-md transition-colors cursor-pointer">
                          Delete
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-center py-12 text-gray-400">
        <i class="fab fa-youtube text-6xl mb-4 text-red-500"></i>
        <p class="text-lg">No videos found{% if current_year != "all" %} for {{ current_year }}{% endif %}</p>
        {% if current_year != "all" or current_filter != "all" %}
          <a href="?" class="text-red-400 hover:text-red-300 mt-2 inline-block cursor-pointer">
            Clear filters
          </a>
        {% endif %}
      </div>
    {% endif %}
  </div>
{% endblock content %}
