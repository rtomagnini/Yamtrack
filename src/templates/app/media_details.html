{% extends "base.html" %}
{% load static %}
{% load app_tags %}

{% block title %}
  {{ media.title }} - Yamtrack
{% endblock title %}

{% block content %}
  {# Top section #}
  <div class="flex flex-col md:flex-row gap-8 md:gap-10 mb-12 md:mb-8">
    <div class="w-full md:w-1/4 max-w-[250px] mx-auto md:mx-0">
      <img alt="{{ media.title }}"
           class="w-full rounded-lg shadow-lg bg-[#2a2f35] object-cover"
           src="{{ media.image }}">
    </div>

    {# Media details #}
    <div class="md:w-3/4">
      {% if media.media_type == "season" %}
        <h2 class="text-xl font-semibold cursor-pointer hover:text-indigo-500 transition-colors duration-200 mb-2 text-gray-400 text-center md:text-start">
          <a href="{% url 'media_details' source=media.source media_type="tv" media_id=media.media_id title=media.title|slug %}">{{ media.title }}</a>
        </h2>
        <div class="flex flex-col md:flex-row gap-y-4 md:gap-y-0 items-center justify-between mb-6">
          <h1 class="text-3xl font-bold">{{ media.season_title }}</h1>
          <div class="relative"
               x-data="{ open: false }"
               @click.away="open = false"
               @keydown.escape.window="open = false">
            <button @click="open = !open"
                    class="flex items-center space-x-2 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-md transition-colors duration-200 cursor-pointer">
              <span class="text-sm font-medium">{{ media.season_title }}</span>
              <svg xmlns="http://www.w3.org/2000/svg"
                   width="16"
                   height="16"
                   viewBox="0 0 24 24"
                   fill="none"
                   stroke="currentColor"
                   stroke-width="2"
                   stroke-linecap="round"
                   stroke-linejoin="round"
                   :class="{ 'rotate-180': open }">
                <path d="m6 9 6 6 6-6"></path>
              </svg>
            </button>
            <div x-show="open"
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 transform scale-95"
                 x-transition:enter-end="opacity-100 transform scale-100"
                 x-transition:leave="transition ease-in duration-150"
                 x-transition:leave-start="opacity-100 transform scale-100"
                 x-transition:leave-end="opacity-0 transform scale-95"
                 class="absolute right-1/2 md:right-0 translate-x-1/2 md:translate-x-0 mt-2 w-64 bg-[#2a2f35] rounded-md shadow-lg overflow-hidden z-10">
              <div class="max-h-[300px] overflow-y-auto">
                {% for tv_season in tv.related.seasons %}
                  <a href="{% url 'season_details' source=media.source media_id=media.media_id title=media.title|slug season_number=tv_season.season_number %}"
                     class="w-full px-4 py-3 flex items-center space-x-3 hover:bg-gray-700 transition-colors duration-200 cursor-pointer {% if tv_season.season_number == media.season_number %}bg-[#343a40]{% endif %}">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center bg-indigo-600 text-white">
                      {{ tv_season.season_number }}
                    </div>
                    <div class="flex-1 text-left">
                      <div class="text-sm font-medium">{{ tv_season.season_title }}</div>
                      <div class="text-xs text-gray-400">
                        {{ tv_season.max_progress }} Episodes
                        {% if tv_season.first_air_date %}• {{ tv_season.first_air_date }}{% endif %}
                      </div>
                    </div>
                  </a>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      {% else %}
        <h1 class="text-3xl font-bold mb-4 text-center md:text-start">{{ media.title }}</h1>
      {% endif %}
      <p class="text-gray-300 mb-6 line-clamp-6 text-justify text-pretty">{{ media.synopsis|linebreaksbr|safe }}</p>
      <div class="flex flex-wrap gap-2 mb-6">
        {% for genre in media.genres %}
          <span class="px-3 py-1 bg-violet-600 text-white rounded-full text-sm">{{ genre }}</span>
        {% endfor %}
      </div>
      <div class="flex items-center space-x-4">
        {# Track #}
        <div x-data="{ trackOpen: false }">
          <button class="inline-flex items-center justify-center px-4 py-2 space-x-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-300 cursor-pointer"
                  hx-get="{% modal_url 'track' media %}"
                  hx-vals='{"return_url": "{{ request.get_full_path|urlencode }}"}'
                  hx-target="#{% component_id 'track' media %}"
                  hx-trigger="click once"
                  @click="trackOpen = true">
            <svg xmlns="http://www.w3.org/2000/svg"
                 width="24"
                 height="24"
                 viewBox="0 0 24 24"
                 fill="none"
                 stroke="currentColor"
                 stroke-width="2"
                 stroke-linecap="round"
                 stroke-linejoin="round"
                 class="w-4 h-4">
              <path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.375 2.625a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4Z"></path>
            </svg>
            <span>Track</span>
          </button>

          <div x-show="trackOpen"
               @keydown.escape.window="trackOpen = false"
               class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="w-[32rem] max-h-[90vh] px-4 md:px-0 relative z-60"
                 @click.outside="trackOpen = false">
              <div id="{% component_id 'track' media %}"></div>
            </div>
          </div>
        </div>

        {# Custom Lists #}
        <div x-data="{ listsOpen: false }">
          <button class="inline-flex items-center justify-center px-4 py-2 space-x-2 bg-emerald-600 text-white rounded-md hover:bg-emerald-700 transition duration-300 cursor-pointer"
                  hx-get="{% modal_url 'lists' media %}"
                  hx-vals='{"return_url": "{{ request.get_full_path|urlencode }}"}'
                  hx-target="#{% component_id 'lists' media %}"
                  hx-trigger="click once"
                  @click="listsOpen = true">
            <svg xmlns="http://www.w3.org/2000/svg"
                 width="24"
                 height="24"
                 viewBox="0 0 24 24"
                 fill="none"
                 stroke="currentColor"
                 stroke-width="2"
                 stroke-linecap="round"
                 stroke-linejoin="round"
                 class="w-4 h-4">
              <path d="M11 12H3"></path>
              <path d="M16 6H3"></path>
              <path d="M16 18H3"></path>
              <path d="M18 9v6"></path>
              <path d="M21 12h-6"></path>
            </svg>
            <span>Custom Lists</span>
          </button>

          <div x-show="listsOpen"
               @keydown.escape.window="listsOpen = false"
               class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="w-96 max-h-[90vh] px-4 md:px-0 relative z-60"
                 @click.outside="listsOpen = false">
              <div id="{% component_id 'lists' media %}"></div>
            </div>
          </div>
        </div>

        {# History #}
        <div x-data="{ historyOpen: false }">
          <button class="inline-flex items-center justify-center px-4 py-2 space-x-2 bg-amber-600 text-white rounded-md hover:bg-amber-700 transition duration-300 cursor-pointer"
                  hx-get="{% modal_url 'history' media %}"
                  hx-vals='{"return_url": "{{ request.get_full_path|urlencode }}"}'
                  hx-target="#{% component_id 'history' media %}"
                  hx-trigger="click once"
                  @click="historyOpen = true">
            <svg xmlns="http://www.w3.org/2000/svg"
                 width="24"
                 height="24"
                 viewBox="0 0 24 24"
                 fill="none"
                 stroke="currentColor"
                 stroke-width="2"
                 stroke-linecap="round"
                 stroke-linejoin="round"
                 class="w-4 h-4">
              <path d="M21 7.5V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h3.5"></path>
              <path d="M16 2v4"></path>
              <path d="M8 2v4"></path>
              <path d="M3 10h5"></path>
              <path d="M17.5 17.5 16 16.3V14"></path>
              <circle cx="16" cy="16" r="6"></circle>
            </svg>
            <span>Activity</span>
          </button>

          <div x-show="historyOpen"
               @keydown.escape.window="historyOpen = false"
               class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="w-96 max-h-[90vh] px-4 md:px-0 relative z-60"
                 @click.outside="historyOpen = false">
              <div id="{% component_id 'history' media %}"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="flex flex-col md:flex-row gap-12 md:gap-10">
    {# Details Column #}
    <div class="w-full md:w-1/4 md:max-w-[250px]">
      <h2 class="text-2xl font-bold mb-4">Details</h2>
      <div class="bg-[#2a2f35] p-4 rounded-lg text-center md:text-start">
        {% for key, value in media.details.items %}
          <div class="mb-4 last:mb-0">
            <h3 class="text-sm font-semibold text-gray-400">{{ key|no_underscore|upper }}</h3>
            {% if value|is_list %}
              {% for item in value %}<p class="text-gray-200">{{ item }}</p>{% endfor %}
            {% else %}
              <p class="text-gray-200">{{ value|default_if_none:"Unknown" }}</p>
            {% endif %}
          </div>
        {% empty %}
          <div class="text-gray-200">No details available</div>
        {% endfor %}
      </div>
    </div>

    {# Related Media #}
    {% if media.related %}
      <div class="w-full md:w-3/4">
        {% for name, related_items in media.related.items %}
          {% if related_items %}
            <h2 class="text-2xl font-bold mb-4">{{ name|no_underscore|title }}</h2>
            <div class="grid grid-cols-[repeat(auto-fill,minmax(150px,1fr))] gap-4 {% if not forloop.last %}mb-8{% endif %}">

              {% for media in related_items %}
                {% include "app/components/media_card.html" with media=media %}
              {% endfor %}
            </div>
          {% endif %}
        {% endfor %}
      </div>
    {% endif %}

    {# Episodes List #}
    {% if media.episodes %}
      <div class="w-full md:w-3/4">
        <h2 class="text-2xl font-bold mb-4">Episodes</h2>
        <div class="space-y-6">
          {% for episode in media.episodes %}
            <div class="bg-[#2a2f35] rounded-lg overflow-hidden shadow-lg">
              <div class="flex flex-col md:flex-row">
                <img src="{{ IMG_NONE }}"
                     alt="E{{ episode.episode_number }}"
                     data-src="{{ episode.image }}"
                     class="lazyload md:w-64 md:max-h-40 object-cover flex-shrink-0 {% if episode.image == IMG_NONE %}object-none{% endif %}">
                <div class="p-4 flex-1 flex flex-col">
                  <div class="flex-1">
                    <div class="flex justify-between items-start mb-2 space-x-2">
                      <div>
                        <h2 class="text-xl font-semibold mb-1 line-clamp-1">{{ episode.title }}</h2>
                        <p class="text-sm text-gray-400">
                          Episode {{ episode.episode_number }} • {{ episode.air_date|default_if_none:"Unknown air date" }}
                        </p>
                      </div>
                      <div class="flex space-x-2">
                        {# Track Episode #}
                        <div x-data="{ trackOpen: false }">
                          <button @click="trackOpen = true"
                                  class="p-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full transition duration-300 cursor-pointer">
                            {% if episode.watched %}
                              <svg xmlns="http://www.w3.org/2000/svg"
                                   width="16"
                                   height="16"
                                   viewBox="0 0 24 24"
                                   fill="none"
                                   stroke="currentColor"
                                   stroke-width="2"
                                   stroke-linecap="round"
                                   stroke-linejoin="round">
                                <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                              </svg>
                            {% else %}
                              <svg xmlns="http://www.w3.org/2000/svg"
                                   width="16"
                                   height="16"
                                   viewBox="0 0 24 24"
                                   fill="none"
                                   stroke="currentColor"
                                   stroke-width="2"
                                   stroke-linecap="round"
                                   stroke-linejoin="round">
                                <path d="M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49"></path>
                                <path d="M14.084 14.158a3 3 0 0 1-4.242-4.242"></path>
                                <path d="M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143"></path>
                                <path d="m2 2 20 20"></path>
                              </svg>
                            {% endif %}
                          </button>

                          {# Track Episode Modal #}
                          <div x-show="trackOpen"
                               @keydown.escape.window="trackOpen = false"
                               class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div class="w-[400px] max-h-[90vh] px-4 md:px-0 relative z-60"
                                 @click.outside="trackOpen = false">
                              <div class="bg-[#2a2f35] p-6 rounded-lg">
                                <div class="flex items-center justify-between mb-4">
                                  <h2 class="text-xl font-bold text-white">Track Episode</h2>
                                  <button class="text-gray-400 hover:text-white transition-colors cursor-pointer"
                                          @click="trackOpen = false">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                         width="20"
                                         height="20"
                                         viewBox="0 0 24 24"
                                         fill="none"
                                         stroke="currentColor"
                                         stroke-width="2"
                                         stroke-linecap="round"
                                         stroke-linejoin="round">
                                      <path d="M18 6 6 18"></path>
                                      <path d="m6 6 12 12"></path>
                                    </svg>
                                  </button>
                                </div>

                                {# Episode preview data #}
                                <div class="bg-[#343a40] rounded-lg p-4 mb-6">
                                  <div class="flex items-start gap-4">
                                    <img alt="{{ episode.title }}"
                                         class="w-20 h-20 rounded object-cover flex-shrink-0"
                                         src="{{ episode.image }}">
                                    <div>
                                      <h3 class="text-lg font-semibold mb-1 line-clamp-1">{{ episode.title }}</h3>
                                      <p class="text-sm text-gray-400">Episode {{ episode.episode_number }}</p>
                                      {% if episode.watched %}
                                        {% if episode.repeats == 0 %}
                                          <p class="text-sm text-gray-400 mt-1">Watched once</p>
                                        {% else %}
                                          <p class="text-sm text-gray-400 mt-1">Watched {{ episode.repeats|add:"1" }} times</p>
                                        {% endif %}
                                      {% else %}
                                        <p class="text-sm text-gray-400 mt-1">Not watched yet</p>
                                      {% endif %}
                                    </div>
                                  </div>
                                </div>

                                {# Episode form #}
                                <form method="post"
                                      action="{% url 'episode_handler' %}?next={{ request.path }}">
                                  {% csrf_token %}
                                  <input type="hidden" name="media_id" value="{{ media.media_id }}">
                                  <input type="hidden" name="season_number" value="{{ media.season_number }}">
                                  <input type="hidden" name="source" value="{{ media.source }}">
                                  <input type="hidden"
                                         name="episode_number"
                                         value="{{ episode.episode_number }}">
                                  <div class="space-y-4">
                                    <div>
                                      <label class="block text-sm font-medium text-gray-300 mb-2">Watch Date</label>
                                      {# need because it breaks inputDate value when formatting #}
                                      {# djlint:off #}
                                      <div class="relative" x-data="{ inputDate: '{% if episode.end_date %}{{ episode.end_date|date:'Y-m-d' }}{% else %}{% now 'Y-m-d' %}{% endif %}' }">
                                        <input class="w-full p-3 bg-[#343a40] rounded-md text-white border border-gray-600 focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                                               type="date"
                                               name="date"
                                               onfocus="this.showPicker?.()"
                                               x-model="inputDate">
                                        {% if episode.air_date %}
                                          <button type="button" @click="inputDate = '{{ episode.air_date }}'"
                                                  class="absolute right-2 top-1/2 -translate-y-1/2 flex items-center text-sm text-indigo-400 hover:text-indigo-300 transition-colors bg-[#2a2f35] px-2 py-1 rounded cursor-pointer">
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                 width="24"
                                                 height="24"
                                                 viewBox="0 0 24 24"
                                                 fill="none"
                                                 stroke="currentColor"
                                                 stroke-width="2"
                                                 stroke-linecap="round"
                                                 stroke-linejoin="round"
                                                 class="w-4 h-4 mr-1">
                                              <path d="M8 2v4"></path>
                                              <path d="M16 2v4"></path>
                                              <rect width="18" height="18" x="3" y="4" rx="2"></rect>
                                              <path d="M3 10h18"></path>
                                            </svg>
                                            Air date
                                          </button>
                                        {% endif %}
                                      </div>
                                      {# djlint:on #}
                                    </div>
                                    <div class="flex justify-between gap-3 pt-2">
                                      <button type="submit"
                                              name="unwatch"
                                              {% if not episode.watched %}disabled{% endif %}
                                              class="px-4 py-2 rounded-md transition-colors {% if episode.watched %}bg-red-700 text-white hover:bg-red-800 cursor-pointer{% else %}bg-gray-600 text-gray-300 cursor-not-allowed{% endif %}">
                                        Remove watch
                                      </button>
                                      <button type="submit"
                                              name="watch"
                                              class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors cursor-pointer">
                                        Add watch
                                      </button>
                                    </div>
                                  </div>
                                </form>
                              </div>
                            </div>
                          </div>
                        </div>

                        {# Lists #}
                        <div x-data="{ listsOpen: false }">
                          <button class="p-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-full transition duration-300 cursor-pointer"
                                  hx-get="{% modal_url 'lists' episode %}"
                                  hx-vals='{"return_url": "{{ request.get_full_path|urlencode }}"}'
                                  hx-target="#{% component_id 'lists' episode %}"
                                  hx-trigger="click once"
                                  @click="listsOpen = true">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                 width="16"
                                 height="16"
                                 viewBox="0 0 24 24"
                                 fill="none"
                                 stroke="currentColor"
                                 stroke-width="2"
                                 stroke-linecap="round"
                                 stroke-linejoin="round">
                              <path d="M11 12H3"></path>
                              <path d="M16 6H3"></path>
                              <path d="M16 18H3"></path>
                              <path d="M18 9v6"></path>
                              <path d="M21 12h-6"></path>
                            </svg>
                          </button>

                          <div x-show="listsOpen"
                               @keydown.escape.window="listsOpen = false"
                               class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div class="w-96 max-h-[90vh] px-4 md:px-0 relative z-60"
                                 @click.outside="listsOpen = false">
                              <div id="{% component_id 'lists' episode %}"></div>
                            </div>
                          </div>
                        </div>

                        {# History #}
                        <div x-data="{ historyOpen: false }">
                          <button class="p-2 bg-amber-600 hover:bg-amber-700 text-white rounded-full transition duration-300 cursor-pointer"
                                  hx-get="{% modal_url 'history' episode %}"
                                  hx-vals='{"return_url": "{{ request.get_full_path|urlencode }}"}'
                                  hx-target="#{% component_id 'history' episode %}"
                                  hx-trigger="click once"
                                  @click="historyOpen = true">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                 width="16"
                                 height="16"
                                 viewBox="0 0 24 24"
                                 fill="none"
                                 stroke="currentColor"
                                 stroke-width="2"
                                 stroke-linecap="round"
                                 stroke-linejoin="round">
                              <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                              <path d="M3 3v5h5"></path>
                              <path d="M12 7v5l4 2"></path>
                            </svg>
                          </button>
                          <div x-show="historyOpen"
                               @keydown.escape.window="historyOpen = false"
                               class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div class="w-96 max-h-[90vh] px-4 md:px-0 relative z-60"
                                 @click.outside="historyOpen = false">
                              <div id="{% component_id 'history' episode %}"></div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <p class="text-sm text-gray-300 line-clamp-2 text-justify text-pretty">{{ episode.overview }}</p>
                  </div>
                  {% if episode.watched %}
                    <p class="text-xs text-gray-400 mt-2">
                      Last watched: {{ episode.end_date|date:"Y-m-d" }}
                      {% if episode.repeats > 0 %}• Watched {{ episode.repeats|add:"1" }} times{% endif %}
                    </p>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  </div>
{% endblock content %}
