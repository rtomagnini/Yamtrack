{% extends "base.html" %}
{% load app_tags %}
{% load humanize %}

{% block title %}
  {{ media.title }}
  {% if media.media_type == MediaTypes.SEASON.value %}S{{ media.season_number }}{% endif %}
  - Yamtrack
{% endblock title %}

{% block content %}
  {# Top section #}
  <div class="flex flex-col md:flex-row gap-8 md:gap-10 mb-12 md:mb-8">
    <div class="w-full md:w-1/4 max-w-[250px] mx-auto md:mx-0">
      <img alt="{{ media.title }}"
           class="w-full rounded-lg shadow-lg bg-[#2a2f35] object-cover"
           src="{{ media.image }}">

      <div x-data="{ trackOpen: false }">
        <button class="mt-4 p-3 rounded-lg w-full flex items-center text-white transition duration-300 cursor-pointer {% if user_media.status %}bg-indigo-600 hover:bg-indigo-700{% else %}bg-gray-600 hover:bg-gray-700{% endif %}"
                hx-get="{% media_view_url 'track_modal' media %}"
                hx-vals='{"return_url": "{{ request.get_full_path|urlencode }}", "title": "{{ media.title }}{% if media.season_title %} S{{ media.season_number }}{% endif %}"}'
                hx-target="#{% component_id 'track' media %}"
                hx-trigger="click"
                @click="trackOpen = true">
          <div class="flex-1 text-center font-medium">
            {% if user_media %}
              {{ user_media.status|media_status_readable }}
            {% else %}
              Add to tracker
            {% endif %}
          </div>

          <div class="h-5 mx-2 border-l border-white/30"></div>
          <svg xmlns="http://www.w3.org/2000/svg"
               width="24"
               height="24"
               viewBox="0 0 24 24"
               fill="none"
               stroke="currentColor"
               stroke-width="2"
               stroke-linecap="round"
               stroke-linejoin="round"
               class="w-5 h-5 flex-shrink-0">
            <path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.375 2.625a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4Z"></path>
          </svg>
        </button>

        {# Track Modal #}
        <div x-show="trackOpen"
             @keydown.escape.window="trackOpen = false"
             class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div class="w-[38rem] max-h-[90vh] px-4 md:px-0 relative z-60"
               @click.outside="trackOpen = false"
               @click.stop>
            {# stop click propagation to avoid resetting the modal because this one doesn't have click once #}
            <div id="{% component_id 'track' media %}"></div>
          </div>
        </div>
      </div>

    </div>

    {# Media details #}
    <div class="md:w-3/4">
      {% if media.media_type == MediaTypes.SEASON.value %}
        <h2 class="text-xl font-semibold cursor-pointer hover:text-indigo-500 transition-colors duration-200 mb-2 text-gray-400 text-center md:text-start">
          <a href="{% url 'media_details' source=media.source media_type=MediaTypes.TV.value media_id=media.media_id title=media.title|slug %}">{{ media.title }}</a>
        </h2>

        <div class="flex flex-col md:flex-row gap-y-4 md:gap-y-0 items-center justify-between mb-6">
          <h1 class="text-3xl font-bold">{{ media.season_title }}</h1>

          {# Season dropdown #}
          <div class="relative"
               x-data="{ open: false }"
               @click.away="open = false"
               @keydown.escape.window="open = false">
            <button @click="open = !open"
                    class="flex items-center space-x-2 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-md transition-colors duration-200 cursor-pointer">
              <span class="text-sm font-medium">{{ media.season_title }}</span>
              <svg xmlns="http://www.w3.org/2000/svg"
                   width="16"
                   height="16"
                   viewBox="0 0 24 24"
                   fill="none"
                   stroke="currentColor"
                   stroke-width="2"
                   stroke-linecap="round"
                   stroke-linejoin="round"
                   :class="{ 'rotate-180': open }">
                <path d="m6 9 6 6 6-6"></path>
              </svg>
            </button>
            <div x-show="open"
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 transform scale-95"
                 x-transition:enter-end="opacity-100 transform scale-100"
                 x-transition:leave="transition ease-in duration-150"
                 x-transition:leave-start="opacity-100 transform scale-100"
                 x-transition:leave-end="opacity-0 transform scale-95"
                 class="absolute right-1/2 md:right-0 translate-x-1/2 md:translate-x-0 mt-2 w-64 bg-[#2a2f35] rounded-md shadow-lg overflow-hidden z-10">
              <div class="max-h-[300px] overflow-y-auto">
                {% for tv_season in tv.related.seasons %}
                  <a href="{% url 'season_details' source=media.source media_id=media.media_id title=media.title|slug season_number=tv_season.season_number %}"
                     class="w-full px-4 py-3 flex items-center space-x-3 hover:bg-gray-700 transition-colors duration-200 cursor-pointer {% if tv_season.season_number == media.season_number %}bg-[#343a40]{% endif %}">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center bg-indigo-600 text-white">
                      {{ tv_season.season_number }}
                    </div>
                    <div class="flex-1 text-left">
                      <div class="text-sm font-medium">{{ tv_season.season_title }}</div>
                      <div class="text-xs text-gray-400">
                        {{ tv_season.max_progress }} Episode{{ tv_season.max_progress|pluralize }}
                        {% if tv_season.first_air_date %}• {{ tv_season.first_air_date }}{% endif %}
                      </div>
                    </div>
                  </a>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      {% else %}
        <h1 class="text-3xl font-bold mb-4 text-center md:text-start">{{ media.title }}</h1>
      {% endif %}

      {# Genres #}
      <div class="flex flex-wrap gap-2 mb-4">
        {% for genre in media.genres %}
          <span class="px-3 py-1 bg-violet-600 text-white rounded-full text-sm">{{ genre }}</span>
        {% endfor %}
      </div>

      {# Description #}
      <div class="mb-6">
        <p class="text-gray-300 text-justify text-pretty {% if media.media_type == MediaTypes.SEASON.value %}line-clamp-4{% else %}line-clamp-5{% endif %}">
          {{ media.synopsis|linebreaksbr|safe }}
        </p>

        {% if user_media.notes %}
          <div class="my-3 border-t border-gray-700"></div>

          <div class="flex items-start mt-2">
            <svg xmlns="http://www.w3.org/2000/svg"
                 width="24"
                 height="24"
                 viewBox="0 0 24 24"
                 fill="none"
                 stroke="currentColor"
                 stroke-width="2"
                 stroke-linecap="round"
                 stroke-linejoin="round"
                 class="w-5 h-5 mr-2 text-yellow-400 flex-shrink-0 mt-0.5">
              <path d="M16 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8Z"></path>
              <path d="M15 3v4a2 2 0 0 0 2 2h4"></path>
            </svg>
            <div class="font-medium text-gray-400 mb-1">YOUR NOTES</div>
          </div>

          <p class="text-gray-300 italic line-clamp-2">"{{ user_media.notes|linebreaksbr }}"</p>
        {% endif %}
      </div>

      {# Source score #}
      <div class="flex flex-wrap gap-4">
        {% if media.score_count is not None %}
          <div class="bg-[#2a2f35] p-3 rounded-lg w-[120px]">
            <h3 class="text-xs font-semibold text-gray-400 mb-1 text-center">{{ media.source|upper }} SCORE</h3>
            <div class="flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg"
                   width="24"
                   height="24"
                   viewBox="0 0 24 24"
                   fill="none"
                   stroke="currentColor"
                   stroke-width="2"
                   stroke-linecap="round"
                   stroke-linejoin="round"
                   class="w-5 h-5 mr-1.5 text-yellow-400 fill-yellow-400">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
              </svg>
              {% if media.score is not None %}
                <span class="text-lg font-bold text-white">{{ media.score }}</span><span class="text-gray-400 ml-0.5 text-sm">/10</span>
              {% else %}
                <span class="text-lg font-bold text-gray-400">-</span>
              {% endif %}
            </div>
            <p class="text-xs text-gray-400 mt-0.5 text-center">
              {{ media.score_count|intcomma }} vote{{ media.score_count|pluralize }}
            </p>
          </div>
        {% endif %}

        {# User score #}
        {% if user_media %}
          <div x-data="{ showRatingPopup: false, rating: {{ user_media.score|default:'null' }}, hoverRating: null, isHovering: false }"
               class="relative">
            <!-- Rating display -->
            <div @click="showRatingPopup = !showRatingPopup"
                 class="bg-[#2a2f35] p-3 rounded-lg w-[120px] cursor-pointer">
              <h3 class="text-xs font-semibold text-gray-400 mb-1 text-center">YOUR SCORE</h3>
              <div class="flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg"
                     width="24"
                     height="24"
                     viewBox="0 0 24 24"
                     fill="none"
                     stroke="currentColor"
                     stroke-width="2"
                     stroke-linecap="round"
                     stroke-linejoin="round"
                     class="w-5 h-5 mr-1.5 text-yellow-400 fill-yellow-400">
                  <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                </svg>
                <template x-if="rating">
                  <div class="flex items-baseline">
                    <span class="text-lg font-bold text-white" x-text="rating"></span>
                    <span class="text-gray-400 ml-0.5 text-sm">/10</span>
                  </div>
                </template>
                <template x-if="!rating">
                  <span class="text-lg font-bold text-gray-400">-</span>
                </template>
              </div>
              <p class="text-xs text-gray-400 mt-0.5 text-center">Click to edit</p>
            </div>

            <!-- Rating popup -->
            <div x-show="showRatingPopup"
                 @click.outside="showRatingPopup = false; isHovering = false"
                 class="absolute left-0 top-full mt-2 p-3 bg-[#2a2f35] rounded-lg shadow-lg z-10 w-[250px] border border-gray-700"
                 @mouseenter="isHovering = true"
                 @mouseleave="isHovering = false; hoverRating = null">
              <div class="flex justify-between mb-1">
                {% with rating_range=10|get_range %}
                  {% for rating_value in rating_range %}
                    <button @click="rating = {{ rating_value }}; showRatingPopup = false; isHovering = false"
                            @mouseenter="hoverRating = {{ rating_value }}"
                            hx-post="{% media_view_url 'update_media_score' user_media.item %}"
                            hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                            hx-vals='{"score": {{ rating_value }}, "item_id": {{ user_media.item.id }} }'
                            hx-trigger="click"
                            hx-swap="none"
                            class="focus:outline-none flex flex-col items-center cursor-pointer">
                      <svg xmlns="http://www.w3.org/2000/svg"
                           width="24"
                           height="24"
                           viewBox="0 0 24 24"
                           fill="none"
                           stroke="currentColor"
                           stroke-width="2"
                           stroke-linecap="round"
                           stroke-linejoin="round"
                           class="w-5 h-5 hover:scale-110 transition-transform"
                           :class="{ 'text-yellow-400 fill-yellow-400': {{ rating_value }} <= (isHovering ? hoverRating : rating), 'text-gray-600': {{ rating_value }} > (isHovering ? hoverRating : rating) }">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                      </svg>
                      <span class="text-xs mt-1 text-gray-400">{{ rating_value }}</span>
                    </button>
                  {% endfor %}
                {% endwith %}
              </div>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="flex flex-col md:flex-row gap-12 md:gap-10">
    {# Details Column #}

    <div class="w-full md:w-1/4 md:max-w-[250px] mx-auto lg:mx-0">
      {# Your History #}
      {% if user_media %}
        <h2 class="text-xl font-bold mb-4">Your History</h2>
        <div class="bg-[#2a2f35] p-4 rounded-lg text-center md:text-start mb-6">
          <div class="flex flex-col gap-y-1">
            {% if user_media.start_date %}
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">Started:</span>
                <span class="text-gray-200">{{ user_media.start_date|date:"DATETIME_FORMAT" }}</span>
              </div>
            {% endif %}

            {% if user_media.end_date %}
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">Ended:</span>
                <span class="text-gray-200">{{ user_media.end_date|date:"DATETIME_FORMAT" }}</span>
              </div>
            {% endif %}

            {% if media.media_type != MediaTypes.MOVIE.value %}
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">Progress:</span>
                <span class="text-gray-200">
                  {{ user_media.formatted_progress }}
                  {% if user_media.max_progress %}/ {{ user_media.max_progress }}{% endif %}
                </span>
              </div>
            {% endif %}

            {% if user_media.repeats and media.media_type != MediaTypes.TV.value and media.media_type != MediaTypes.SEASON.value %}
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">Repeats:</span>
                <div class="flex items-center text-gray-200">
                  <svg xmlns="http://www.w3.org/2000/svg"
                       width="24"
                       height="24"
                       viewBox="0 0 24 24"
                       fill="none"
                       stroke="currentColor"
                       stroke-width="2"
                       stroke-linecap="round"
                       stroke-linejoin="round"
                       class="w-4 h-4 mr-1">
                    <path d="m17 2 4 4-4 4"></path>
                    <path d="M3 11v-1a4 4 0 0 1 4-4h14"></path>
                    <path d="m7 22-4-4 4-4"></path>
                    <path d="M21 13v1a4 4 0 0 1-4 4H3"></path>
                  </svg>
                  <span>{{ user_media.repeats }}x</span>
                </div>
              </div>
            {% endif %}
          </div>
        </div>
      {% endif %}

      {# Actions #}
      <h2 class="text-xl font-bold mb-4">Actions</h2>
      <div class="bg-[#2a2f35] p-4 md:p-2 lg:p-4 rounded-lg flex items-center justify-center gap-x-5 md:gap-x-2 lg:gap-x-5 mb-6">
        {# Custom Lists #}
        <div x-data="{ listsOpen: false }">
          <button class="px-4 py-2 bg-emerald-600 text-white rounded-md hover:bg-emerald-700 transition duration-300 cursor-pointer"
                  title="Add to custom lists"
                  hx-get="{% media_view_url 'lists_modal' media %}"
                  hx-vals='{"return_url": "{{ request.get_full_path|urlencode }}"}'
                  hx-target="#{% component_id 'lists' media %}"
                  hx-trigger="click once"
                  @click="listsOpen = true">
            <svg xmlns="http://www.w3.org/2000/svg"
                 width="24"
                 height="24"
                 viewBox="0 0 24 24"
                 fill="none"
                 stroke="currentColor"
                 stroke-width="2"
                 stroke-linecap="round"
                 stroke-linejoin="round"
                 class="w-4 h-4">
              <path d="M12 10v6" />
              <path d="M9 13h6" />
              <path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z" />
            </svg>
          </button>

          <div x-show="listsOpen"
               @keydown.escape.window="listsOpen = false"
               class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="w-96 max-h-[90vh] px-4 md:px-0 relative z-60"
                 @click.outside="listsOpen = false">
              <div id="{% component_id 'lists' media %}"></div>
            </div>
          </div>
        </div>

        {# Activity History #}
        <div x-data="{ historyOpen: false }">
          <button class="px-4 py-2 bg-amber-600 text-white rounded-md hover:bg-amber-700 transition duration-300 cursor-pointer"
                  title="View your activity history"
                  hx-get="{% media_view_url 'history_modal' media %}"
                  hx-vals='{"return_url": "{{ request.get_full_path|urlencode }}"}'
                  hx-target="#{% component_id 'history' media %}"
                  hx-trigger="click once"
                  @click="historyOpen = true">
            <svg xmlns="http://www.w3.org/2000/svg"
                 width="24"
                 height="24"
                 viewBox="0 0 24 24"
                 fill="none"
                 stroke="currentColor"
                 stroke-width="2"
                 stroke-linecap="round"
                 stroke-linejoin="round"
                 class="w-4 h-4">
              <path d="M21 7.5V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h3.5"></path>
              <path d="M16 2v4"></path>
              <path d="M8 2v4"></path>
              <path d="M3 10h5"></path>
              <path d="M17.5 17.5 16 16.3V14"></path>
              <circle cx="16" cy="16" r="6"></circle>
            </svg>
          </button>

          <div x-show="historyOpen"
               @keydown.escape.window="historyOpen = false"
               class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="w-96 max-h-[90vh] px-4 md:px-0 relative z-60"
                 @click.outside="historyOpen = false">
              <div id="{% component_id 'history' media %}"></div>
            </div>
          </div>
        </div>

        {# Sync metadata #}
        <button type="button"
                title="Sync with source"
                class="px-4 py-2 bg-fuchsia-600 text-white rounded-md hover:bg-fuchsia-700 transition duration-300 cursor-pointer disabled:opacity-75"
                hx-post="{% media_view_url 'sync_metadata' media %}"
                hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                hx-vals='{"next": "{{ request.get_full_path|urlencode }}"}'
                hx-target="body"
                hx-swap="none"
                x-data="{ loading: false }"
                @click="loading = true"
                :disabled="loading">
          <svg xmlns="http://www.w3.org/2000/svg"
               width="24"
               height="24"
               viewBox="0 0 24 24"
               fill="none"
               stroke="currentColor"
               stroke-width="2"
               stroke-linecap="round"
               stroke-linejoin="round"
               class="w-4 h-4"
               :class="{ 'animate-spin': loading }">
            <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
            <path d="M21 3v5h-5"></path>
            <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
            <path d="M8 16H3v5"></path>
          </svg>
        </button>
      </div>

      {# Media Details #}
      <h2 class="text-xl font-bold mb-4">Details</h2>
      <div class="bg-[#2a2f35] p-4 rounded-lg text-center md:text-start">
        {% if media.details.items %}
          {% for key, value in media.details.items %}
            <div class="mb-4">
              <h3 class="text-sm font-semibold text-gray-400">{{ key|no_underscore|upper }}</h3>
              {% if value|is_list %}
                {% for item in value %}<p class="text-gray-200">{{ item }}</p>{% endfor %}
              {% else %}
                <p class="text-gray-200">{{ value|default_if_none:"Unknown" }}</p>
              {% endif %}
            </div>
          {% endfor %}
          {% if media.source != Sources.MANUAL.value %}
            <div>
              <h3 class="text-sm font-semibold text-gray-400">Source</h3>
              <a href="{{ media.source_url }}"
                 class="text-gray-200 hover:text-indigo-500 transition-colors duration-200"
                 target="_blank">{{ media.source|source_readable }}</a>
            </div>
          {% endif %}
        {% else %}
          <div class="text-gray-200">No details available</div>
        {% endif %}
      </div>
    </div>

    {# Related Media #}
    {% if media.related %}
      <div class="w-full md:w-3/4">
        {% for name, related_items in media.related.items %}
          {% if related_items %}
            <section class="{% if not forloop.last %}mb-8{% endif %}">
              <h2 class="text-xl font-bold mb-4">{{ name|no_underscore|title }}</h2>
              <div class="grid grid-cols-[repeat(auto-fill,minmax(150px,1fr))] gap-4">
                {% for item in related_items %}
                  {% include "app/components/media_card.html" with item=item title=item.season_title|default:item.title media=None %}
                {% endfor %}
              </div>
            </section>
          {% endif %}
        {% endfor %}
      </div>
    {% endif %}

    {# Episodes List #}
    {% if media.episodes %}
      <div class="w-full">
        <h2 class="text-xl font-bold mb-4">Episodes</h2>
        <div class="space-y-6">
          {% for episode in media.episodes %}
            <div class="bg-[#2a2f35] rounded-lg overflow-hidden shadow-lg">
              <div class="flex flex-col md:flex-row">
                <img src="{{ IMG_NONE }}"
                     alt="E{{ episode.episode_number }}"
                     data-src="{{ episode.image }}"
                     class="lazyload md:w-64 md:max-h-40 flex-shrink-0 {% if episode.image != IMG_NONE %}object-cover{% endif %}">
                <div class="p-4 flex-1 flex flex-col">
                  <div class="flex-1">
                    <div class="flex justify-between items-start mb-2 space-x-2">
                      <div>
                        <h2 class="text-xl font-semibold mb-1 line-clamp-1">{{ episode.title }}</h2>
                        <p class="text-sm text-gray-400">
                          Episode {{ episode.episode_number }} • {{ episode.air_date|default_if_none:"Unknown air date" }}
                        </p>
                      </div>
                      <div class="flex space-x-2">
                        {# Track Episode #}
                        <div x-data="{ trackOpen: false }">
                          <button @click="trackOpen = true"
                                  class="p-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full transition duration-300 cursor-pointer">
                            {% if episode.watched %}
                              <svg xmlns="http://www.w3.org/2000/svg"
                                   width="16"
                                   height="16"
                                   viewBox="0 0 24 24"
                                   fill="none"
                                   stroke="currentColor"
                                   stroke-width="2"
                                   stroke-linecap="round"
                                   stroke-linejoin="round">
                                <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                              </svg>
                            {% else %}
                              <svg xmlns="http://www.w3.org/2000/svg"
                                   width="16"
                                   height="16"
                                   viewBox="0 0 24 24"
                                   fill="none"
                                   stroke="currentColor"
                                   stroke-width="2"
                                   stroke-linecap="round"
                                   stroke-linejoin="round">
                                <path d="M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49"></path>
                                <path d="M14.084 14.158a3 3 0 0 1-4.242-4.242"></path>
                                <path d="M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143"></path>
                                <path d="m2 2 20 20"></path>
                              </svg>
                            {% endif %}
                          </button>

                          {% include "app/components/fill_track_episode.html" with request=request media=media episode=episode episode_title=episode.title csrf_token=csrf_token only %}

                        </div>

                        {# Lists #}
                        <div x-data="{ listsOpen: false }">
                          <button class="p-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-full transition duration-300 cursor-pointer"
                                  hx-get="{% media_view_url 'lists_modal' episode %}"
                                  hx-vals='{"return_url": "{{ request.get_full_path|urlencode }}"}'
                                  hx-target="#{% component_id 'lists' episode %}"
                                  hx-trigger="click once"
                                  @click="listsOpen = true">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                 width="16"
                                 height="16"
                                 viewBox="0 0 24 24"
                                 fill="none"
                                 stroke="currentColor"
                                 stroke-width="2"
                                 stroke-linecap="round"
                                 stroke-linejoin="round">
                              <path d="M11 12H3"></path>
                              <path d="M16 6H3"></path>
                              <path d="M16 18H3"></path>
                              <path d="M18 9v6"></path>
                              <path d="M21 12h-6"></path>
                            </svg>
                          </button>

                          <div x-show="listsOpen"
                               @keydown.escape.window="listsOpen = false"
                               class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div class="w-96 max-h-[90vh] px-4 md:px-0 relative z-60"
                                 @click.outside="listsOpen = false">
                              <div id="{% component_id 'lists' episode %}"></div>
                            </div>
                          </div>
                        </div>

                        {# History #}
                        <div x-data="{ historyOpen: false }">
                          <button class="p-2 bg-amber-600 hover:bg-amber-700 text-white rounded-full transition duration-300 cursor-pointer"
                                  hx-get="{% media_view_url 'history_modal' episode %}"
                                  hx-vals='{"return_url": "{{ request.get_full_path|urlencode }}"}'
                                  hx-target="#{% component_id 'history' episode %}"
                                  hx-trigger="click once"
                                  @click="historyOpen = true">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                 width="16"
                                 height="16"
                                 viewBox="0 0 24 24"
                                 fill="none"
                                 stroke="currentColor"
                                 stroke-width="2"
                                 stroke-linecap="round"
                                 stroke-linejoin="round">
                              <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                              <path d="M3 3v5h5"></path>
                              <path d="M12 7v5l4 2"></path>
                            </svg>
                          </button>
                          <div x-show="historyOpen"
                               @keydown.escape.window="historyOpen = false"
                               class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div class="w-96 max-h-[90vh] px-4 md:px-0 relative z-60"
                                 @click.outside="historyOpen = false">
                              <div id="{% component_id 'history' episode %}"></div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <p class="text-sm text-gray-300 line-clamp-2 text-justify text-pretty">{{ episode.overview }}</p>
                  </div>
                  {% if episode.watched %}
                    <p class="text-xs text-gray-400 mt-2">
                      Last watched: {{ episode.end_date|date:"DATETIME_FORMAT" }}
                      {% if episode.repeats > 0 %}• Watched {{ episode.repeats|add:"1" }} times{% endif %}
                    </p>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  </div>
{% endblock content %}
