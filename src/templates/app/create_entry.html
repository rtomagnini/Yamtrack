{% extends "base.html" %}
{% load app_tags %}

{% block title %}
  Create - Yamtrack
{% endblock title %}

{% block content %}
  <div class="mx-auto max-w-4xl">
    <div class="mb-8">
      <h1 class="text-3xl font-bold mb-2">Create Custom Entry</h1>
      <p class="text-gray-400">Add a custom media entry to your collection if it's not available in the database.</p>
    </div>
    {# djlint:off #}
    <form method="post" class="space-y-6" x-data="{
  mediaType: '{{ initial_media_type|default:'youtube_video' }}',
    
      updateImagePreview(input) {
        const previewDiv = document.getElementById('image-preview');
        const imageUrl = input.value.trim();
        
        if (imageUrl) {
          // Clear the preview div
          previewDiv.innerHTML = '';
          
          // Create the image element
          const img = document.createElement('img');
          img.alt = 'Preview';
          img.className = 'w-full h-full object-cover';
          img.src = imageUrl;
          
          // Handle image load error
          img.onerror = function() {
            previewDiv.innerHTML = `
              <svg xmlns='http://www.w3.org/2000/svg'
                   width='24'
                   height='24'
                   viewBox='0 0 24 24'
                   fill='none'
                   stroke='currentColor'
                   stroke-width='2'
                   stroke-linecap='round'
                   stroke-linejoin='round'
                   class='w-8 h-8 text-red-500'>
                <circle cx='12' cy='12' r='10'></circle>
                <line x1='15' y1='9' x2='9' y2='15'></line>
                <line x1='9' y1='9' x2='15' y2='15'></line>
              </svg>
            `;
          };
          
          // Add the image to the preview div
          previewDiv.appendChild(img);
        } else {
          // If URL is empty, show the default placeholder icon
          previewDiv.innerHTML = `
            <svg xmlns='http://www.w3.org/2000/svg'
                 width='24'
                 height='24'
                 viewBox='0 0 24 24'
                 fill='none'
                 stroke='currentColor'
                 stroke-width='2'
                 stroke-linecap='round'
                 stroke-linejoin='round'
                 class='w-8 h-8 text-gray-500'>
              <rect width='18' height='18' x='3' y='3' rx='2' ry='2'></rect><circle cx='9' cy='9' r='2'></circle>
              <path d='m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21'></path>
            </svg>
          `;
        }
      },
    
      showField(field) {
        // TV Show fields
        if (this.mediaType === 'tv') {
          return ['title', 'image', 'score', 'status', 'notes'].includes(field);
        }
    
        // Season fields
        else if (this.mediaType === 'season') {
          return ['parentShow', 'image', 'seasonNumber', 'score', 'status', 'notes'].includes(field);
        }
    
        // Episode fields
        else if (this.mediaType === 'episode') {
          return ['parentSeason', 'title', 'episodeNumber', 'youtubeUrl', 'image', 'airDate', 'runtime'].includes(field);
        }
    
        // YouTube Channel fields
        else if (this.mediaType === 'youtube') {
          return ['title', 'channelUrl', 'image', 'score', 'status', 'notes'].includes(field);
        }
    
        // YouTube Video fields
        else if (this.mediaType === 'youtube_video') {
          return ['title', 'youtubeUrl', 'image', 'airDate', 'runtime', 'notes'].includes(field);
        }
    
        // Movie, Anime, Manga, Game, Book fields
        else {
          return ['title', 'image', 'score', 'progress', 'status', 'startDate', 'endDate', 'notes'].includes(field);
        }
      },
    
      getProgressLabel() {
        if (this.mediaType === 'anime') return 'Progress (Episodes)';
        if (this.mediaType === 'manga') return 'Progress (Chapters)';
        if (this.mediaType === 'game') return 'Progress (Play Time)';
        if (this.mediaType === 'book') return 'Progress (Pages)';
        return 'Progress';
      },
    
      validateForm() {
        // Validate parent TV selection for Season
        if (this.mediaType === 'season') {
          const parentTvId = document.getElementById('parent-tv-id').value;
          if (!parentTvId) {
            alert('Please select a parent TV show from the dropdown');
            return false;
          }
        }
    
        // Validate parent Season selection for Episode
        if (this.mediaType === 'episode') {
          const parentSeasonId = document.getElementById('parent-season-id').value;
          if (!parentSeasonId) {
            alert('Please select a parent Season from the dropdown');
            return false;
          }
        }
    
        return true;
      }
    }" @submit.prevent="validateForm() && $event.target.submit()">
    {# djlint:on #}
    {% csrf_token %}
    <input type="hidden" name="media_type" :value="mediaType">

    <div class="bg-[#2a2f35] rounded-lg p-6">
      <div class="grid gap-6">
        <div x-cloak>
          <label class="block text-sm font-medium mb-2 text-gray-300">Media Type</label>
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
            {# Render YouTube Video first #}
            {% for media_type in media_types %}
              {% if media_type == 'youtube_video' %}
                <button type="button"
                        @click="mediaType = '{{ media_type }}'"
                        :class="mediaType === '{{ media_type }}' ? 'bg-indigo-600 border-indigo-500 text-white' : 'border-gray-600 text-gray-300 hover:bg-[#39404b]'"
                        class="flex items-center gap-2 p-3 rounded-md border transition-colors cursor-pointer">
                  {% icon media_type is_active=False %}
                  <span class="text-sm font-medium">{{ media_type|media_type_readable }}</span>
                </button>
              {% endif %}
            {% endfor %}
            {# Then all except YouTube and YouTube Video #}
            {% for media_type in media_types %}
              {% if media_type != 'youtube' and media_type != 'youtube_video' %}
                <button type="button"
                        @click="mediaType = '{{ media_type }}'"
                        :class="mediaType === '{{ media_type }}' ? 'bg-indigo-600 border-indigo-500 text-white' : 'border-gray-600 text-gray-300 hover:bg-[#39404b]'"
                        class="flex items-center gap-2 p-3 rounded-md border transition-colors cursor-pointer">
                  {% icon media_type is_active=False %}
                  <span class="text-sm font-medium">{{ media_type|media_type_readable }}</span>
                </button>
              {% endif %}
            {% endfor %}
            {# Do NOT render the YouTube channel button at all #}
          </div>
        </div>

        <!-- Title field (TV, Movie, Anime, Manga, Game, Book) -->
        <div x-show="showField('title')">
          <label class="block text-sm font-medium mb-2 text-gray-300">Title</label>
          <input class="w-full p-2 bg-[#39404b] rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-[#4a9eff] appearance-none"
                 placeholder="Enter title"
                 name="title"
                 type="text"
                 value="">
        </div>

        <!-- YouTube Channel URL field (YouTube) -->
        <div x-show="showField('channelUrl')"
             x-data="youtubeChannelExtractor()"
             class="youtube-channel-container">
          <label class="block text-sm font-medium mb-2 text-gray-300">
            YouTube Channel URL 
            <span class="text-xs text-gray-400">(auto-fills channel info)</span>
          </label>
          <div class="flex gap-2">
            <input x-ref="channelInput"
                   class="flex-1 p-2 bg-[#39404b] rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-[#4a9eff] appearance-none"
                   name="channel_url"
                   placeholder="https://www.youtube.com/@channelname or https://www.youtube.com/c/channelname"
                   type="url"
                   value="">
            <button type="button"
                    @click="extractChannelMetadata()"
                    :disabled="loading"
                    class="px-4 py-2 bg-red-600 hover:bg-red-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white rounded-md font-medium transition-colors flex items-center gap-2">
              <svg x-show="loading" class="animate-spin w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <span x-text="loading ? 'Extracting...' : 'Extract Info'"></span>
            </button>
          </div>
          <p class="text-xs text-gray-400 mt-1">
            Enter a YouTube channel URL to automatically fetch channel name, description, and thumbnail.
          </p>
        </div>

        <!-- Parent TV Show field (Season) -->
        <div x-show="showField('parentShow')">
          <label class="block text-sm font-medium mb-2 text-gray-300">Parent TV Show</label>
          <div class="relative">
            <div class="relative">
              <input id="parent-tv-input"
                     class="w-full p-2 pl-9 bg-[#39404b] rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-[#4a9eff] appearance-none"
                     placeholder="Search for a TV show..."
                     name="q"
                     type="text"
                     autocomplete="off"
                     hx-get="{% url 'search_parent_tv' %}"
                     hx-trigger="keyup changed delay:300ms"
                     hx-target="#parent-tv-results">
              <!-- Hidden input to store the selected TV ID -->
              <input id="parent-tv-id" name="parent_tv" type="hidden">
              <svg xmlns="http://www.w3.org/2000/svg"
                   width="24"
                   height="24"
                   viewBox="0 0 24 24"
                   fill="none"
                   stroke="currentColor"
                   stroke-width="2"
                   stroke-linecap="round"
                   stroke-linejoin="round"
                   class="absolute left-2.5 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.3-4.3"></path>
              </svg>
            </div>
            <div id="parent-tv-results"></div>
          </div>
        </div>

        <!-- Season Number field (Season) -->
        <div x-show="showField('seasonNumber')">
          <label class="block text-sm font-medium mb-2 text-gray-300">Season Number</label>
          <div class="relative">
              <input min="1"
                     max="9999"
                   class="w-full p-2 pr-12 bg-[#39404b] rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-[#4a9eff] [appearance:textfield] [&amp;::-webkit-outer-spin-button]:appearance-none [&amp;::-webkit-inner-spin-button]:appearance-none"
                   name="season_number"
                   type="number"
                   x-bind:value="mediaType === 'season' ? '1' : ''">
            <div class="absolute inset-y-0 right-0 flex flex-col border-l border-gray-600">
              <button type="button"
                      onclick="this.parentElement.previousElementSibling.stepUp()"
                      class="flex-1 px-2 hover:bg-gray-700 transition-colors rounded-tr-md border-t border-r border-gray-600 group">
                <svg xmlns="http://www.w3.org/2000/svg"
                     width="14"
                     height="14"
                     viewBox="0 0 24 24"
                     fill="none"
                     stroke="currentColor"
                     stroke-width="2"
                     stroke-linecap="round"
                     stroke-linejoin="round"
                     class="group-hover:text-white">
                  <path d="m18 15-6-6-6 6"></path>
                </svg>
              </button>
              <button type="button"
                      onclick="this.parentElement.previousElementSibling.stepDown()"
                      class="flex-1 px-2 hover:bg-gray-700 transition-colors rounded-br-md border-b border-r border-gray-600 group">
                <svg xmlns="http://www.w3.org/2000/svg"
                     width="14"
                     height="14"
                     viewBox="0 0 24 24"
                     fill="none"
                     stroke="currentColor"
                     stroke-width="2"
                     stroke-linecap="round"
                     stroke-linejoin="round"
                     class="group-hover:text-white">
                  <path d="m6 9 6 6 6-6"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>

        <!-- Parent Season field (Episode) -->
        <div x-show="showField('parentSeason')">
          <label class="block text-sm font-medium mb-2 text-gray-300">Parent Season</label>
          <div class="relative">
            <div class="relative">
              <input id="parent-season-input"
                     class="w-full p-2 pl-9 bg-[#39404b] rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-[#4a9eff] appearance-none"
                     placeholder="Search for a season..."
                     name="q"
                     type="text"
                     autocomplete="off"
                     hx-get="{% url 'search_parent_season' %}"
                     hx-trigger="keyup changed delay:300ms"
                     hx-target="#parent-season-results">
              <!-- Hidden input to store the selected Season ID -->
              <input id="parent-season-id" name="parent_season" type="hidden">
              <svg xmlns="http://www.w3.org/2000/svg"
                   width="24"
                   height="24"
                   viewBox="0 0 24 24"
                   fill="none"
                   stroke="currentColor"
                   stroke-width="2"
                   stroke-linecap="round"
                   stroke-linejoin="round"
                   class="absolute left-2.5 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.3-4.3"></path>
              </svg>
            </div>
            <div id="parent-season-results"></div>
          </div>
        </div>

        <!-- Episode Number field (Episode) -->
        <div x-show="showField('episodeNumber')">
          <label class="block text-sm font-medium mb-2 text-gray-300">Episode Number</label>
          <div class="relative">
            <input min="1"
                   max="999"
                   class="w-full p-2 pr-12 bg-[#39404b] rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-[#4a9eff] [appearance:textfield] [&amp;::-webkit-outer-spin-button]:appearance-none [&amp;::-webkit-inner-spin-button]:appearance-none"
                   name="episode_number"
                   type="number"
                   x-bind:value="mediaType === 'episode' ? '1' : ''">
            <div class="absolute inset-y-0 right-0 flex flex-col border-l border-gray-600">
              <button type="button"
                      onclick="this.parentElement.previousElementSibling.stepUp()"
                      class="flex-1 px-2 hover:bg-gray-700 transition-colors rounded-tr-md border-t border-r border-gray-600 group">
                <svg xmlns="http://www.w3.org/2000/svg"
                     width="14"
                     height="14"
                     viewBox="0 0 24 24"
                     fill="none"
                     stroke="currentColor"
                     stroke-width="2"
                     stroke-linecap="round"
                     stroke-linejoin="round"
                     class="group-hover:text-white">
                  <path d="m18 15-6-6-6 6"></path>
                </svg>
              </button>
              <button type="button"
                      onclick="this.parentElement.previousElementSibling.stepDown()"
                      class="flex-1 px-2 hover:bg-gray-700 transition-colors rounded-br-md border-b border-r border-gray-600 group">
                <svg xmlns="http://www.w3.org/2000/svg"
                     width="14"
                     height="14"
                     viewBox="0 0 24 24"
                     fill="none"
                     stroke="currentColor"
                     stroke-width="2"
                     stroke-linecap="round"
                     stroke-linejoin="round"
                     class="group-hover:text-white">
                  <path d="m6 9 6 6 6-6"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>

        <!-- YouTube URL field (Episode) -->
        <div x-show="showField('youtubeUrl')"
             x-data="youtubeExtractor()"
             class="youtube-url-container">
          <label class="block text-sm font-medium mb-2 text-gray-300">
            YouTube URL 
            <span class="text-xs text-gray-400">(optional - auto-fills episode info)</span>
          </label>
          <div class="flex gap-2">
            <input x-ref="youtubeInput"
                   class="flex-1 p-2 bg-[#39404b] rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-[#4a9eff] appearance-none"
                   name="youtube_url"
                   placeholder="https://www.youtube.com/watch?v=..."
                   type="url"
                   value="">
            <button type="button"
                    @click="extractMetadata()"
                    :disabled="loading"
                    class="px-4 py-2 bg-red-600 hover:bg-red-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white rounded-md font-medium transition-colors flex items-center gap-2">
              <svg x-show="loading" class="animate-spin w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <span x-text="loading ? 'Extracting...' : 'Extract Info'"></span>
            </button>
          </div>
          <p class="text-xs text-gray-400 mt-1">
            Paste a YouTube URL and click "Extract Info" to automatically fill episode title, thumbnail, air date, and duration.
          </p>
          
          <!-- Channel info display -->
          <div x-show="channelInfo" class="mt-3 p-3 bg-[#2a2f35] rounded-md border border-gray-600">
            <div class="flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500">
                <polygon points="6 3 20 12 6 21 6 3"/>
                <rect width="20" height="14" x="2" y="5" rx="2"/>
              </svg>
              <span class="text-sm font-medium text-gray-300">Detected Channel:</span>
              <span class="text-sm text-white" x-text="channelInfo ? channelInfo.title : ''"></span>
            </div>
            <div x-show="channelInfo && channelInfo.id" class="mt-1 text-xs text-gray-400">
              Channel ID: <span x-text="channelInfo ? channelInfo.id : ''"></span>
            </div>
          </div>
        </div>

        <!-- Image URL field (All types) -->
        <div x-show="showField('image')">
          <label class="block text-sm font-medium mb-2 text-gray-300">Image URL</label>
          <div class="flex gap-4">
            <div class="flex-1">
              <input class="w-full p-2 bg-[#39404b] rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-[#4a9eff] appearance-none"
                     name="image"
                     placeholder="Enter image URL"
                     type="url"
                     value=""
                     x-on:input="updateImagePreview($event.target)">
            </div>
            <div id="image-preview"
                 class="w-20 h-20 rounded-md overflow-hidden bg-[#39404b] border border-gray-600 flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg"
                   width="24"
                   height="24"
                   viewBox="0 0 24 24"
                   fill="none"
                   stroke="currentColor"
                   stroke-width="2"
                   stroke-linecap="round"
                   stroke-linejoin="round"
                   class="w-8 h-8 text-gray-500">
                <rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><circle cx="9" cy="9" r="2"></circle>
                <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path>
              </svg>
            </div>
          </div>
        </div>

        <!-- Score field (TV, Movie, Anime, Manga, Game, Book, Season) -->
        <div x-show="showField('score')">
          <label class="block text-sm font-medium mb-2 text-gray-300">Score</label>
          <div class="relative">
            <input min="0"
                   max="10"
                   class="w-full p-2 pr-12 bg-[#39404b] rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-[#4a9eff] [appearance:textfield] [&amp;::-webkit-outer-spin-button]:appearance-none [&amp;::-webkit-inner-spin-button]:appearance-none"
                   name="score"
                   type="number"
                   placeholder="0-10">
            <div class="absolute inset-y-0 right-0 flex flex-col border-l border-gray-600">
              <button type="button"
                      onclick="this.parentElement.previousElementSibling.stepUp()"
                      class="flex-1 px-2 hover:bg-gray-700 transition-colors rounded-tr-md border-t border-r border-gray-600 group">
                <svg xmlns="http://www.w3.org/2000/svg"
                     width="14"
                     height="14"
                     viewBox="0 0 24 24"
                     fill="none"
                     stroke="currentColor"
                     stroke-width="2"
                     stroke-linecap="round"
                     stroke-linejoin="round"
                     class="group-hover:text-white">
                  <path d="m18 15-6-6-6 6"></path>
                </svg>
              </button>
              <button type="button"
                      onclick="this.parentElement.previousElementSibling.stepDown()"
                      class="flex-1 px-2 hover:bg-gray-700 transition-colors rounded-br-md border-b border-r border-gray-600 group">
                <svg xmlns="http://www.w3.org/2000/svg"
                     width="14"
                     height="14"
                     viewBox="0 0 24 24"
                     fill="none"
                     stroke="currentColor"
                     stroke-width="2"
                     stroke-linecap="round"
                     stroke-linejoin="round"
                     class="group-hover:text-white">
                  <path d="m6 9 6 6 6-6"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>

        <!-- Progress field (Movie, Anime, Manga, Game, Book) -->
        <div x-show="showField('progress')">
          <label class="block text-sm font-medium mb-2 text-gray-300"
                 x-text="getProgressLabel()">Progress</label>

          <div class="relative">
            <input class="w-full p-2 pr-12 bg-[#39404b] rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-[#4a9eff] appearance-none"
                   name="progress"
                   x-bind:type="mediaType === 'game' ? 'text' : 'number'"
                   x-bind:placeholder="mediaType === 'game' ? 'hh:mm' : ''"
                   x-bind:min="mediaType !== 'game' ? 0 : null"
                   x-bind:max="mediaType !== 'game' ? 99999 : null"
                   x-bind:class="{'[appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none': mediaType !== 'game'}"
                   x-bind:value="mediaType !== 'game' ? '0' : ''">

            <div x-show="mediaType !== 'game'"
                 class="absolute inset-y-0 right-0 flex flex-col border-l border-gray-600">
              <button type="button"
                      onclick="this.parentElement.previousElementSibling.stepUp()"
                      class="flex-1 px-2 hover:bg-gray-700 transition-colors rounded-tr-md border-t border-r border-gray-600 group">
                <svg xmlns="http://www.w3.org/2000/svg"
                     width="14"
                     height="14"
                     viewBox="0 0 24 24"
                     fill="none"
                     stroke="currentColor"
                     stroke-width="2"
                     stroke-linecap="round"
                     stroke-linejoin="round"
                     class="group-hover:text-white">
                  <path d="m18 15-6-6-6 6"></path>
                </svg>
              </button>
              <button type="button"
                      onclick="this.parentElement.previousElementSibling.stepDown()"
                      class="flex-1 px-2 hover:bg-gray-700 transition-colors rounded-br-md border-b border-r border-gray-600 group">
                <svg xmlns="http://www.w3.org/2000/svg"
                     width="14"
                     height="14"
                     viewBox="0 0 24 24"
                     fill="none"
                     stroke="currentColor"
                     stroke-width="2"
                     stroke-linecap="round"
                     stroke-linejoin="round"
                     class="group-hover:text-white">
                  <path d="m6 9 6 6 6-6"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>

        <!-- Status field (TV, Movie, Anime, Manga, Game, Book, Season) -->
        <div x-show="showField('status')">
          <label class="block text-sm font-medium mb-2 text-gray-300">Status</label>
          <div class="relative">
            <select class="w-full p-2 bg-[#39404b] rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-[#4a9eff] appearance-none"
                    name="status">
              {% for status in Status.values %}<option value="{{ status }}" {% if status == Status.IN_PROGRESS.value %}selected{% endif %}>{{ status }}</option>{% endfor %}
            </select>
            <div class="absolute inset-y-0 right-2 flex items-center pointer-events-none">
              <svg xmlns="http://www.w3.org/2000/svg"
                   width="16"
                   height="16"
                   viewBox="0 0 24 24"
                   fill="none"
                   stroke="currentColor"
                   stroke-width="2"
                   stroke-linecap="round"
                   stroke-linejoin="round">
                <path d="m6 9 6 6 6-6"></path>
              </svg>
            </div>
          </div>
        </div>

        <!-- Start Date field (Movie, Anime, Manga, Game, Book) -->
        <div x-show="showField('startDate')">
          <label class="block text-sm font-medium mb-2 text-gray-300">Start Date</label>
          <input class="w-full p-2 bg-[#39404b] rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-[#4a9eff] appearance-none"
                 name="start_date"
                 type="date"
                 value="">
        </div>

        <!-- Air Date field (Episode) -->
        <div x-show="showField('airDate')">
          <label class="block text-sm font-medium mb-2 text-gray-300">Air Date</label>
          <input class="w-full p-2 bg-[#39404b] rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-[#4a9eff] appearance-none"
                 name="air_date"
                 type="date"
                 value="">
        </div>

        <!-- Runtime field (Episode) -->
        <div x-show="showField('runtime')">
          <label class="block text-sm font-medium mb-2 text-gray-300">Runtime (minutes)</label>
          <input class="w-full p-2 bg-[#39404b] rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-[#4a9eff] appearance-none"
                 name="runtime"
                 type="number"
                 min="1"
                 placeholder="Duration in minutes"
                 value="">
        </div>

        <!-- End Date field (Movie, Anime, Manga, Game, Book) -->
        <div x-show="showField('endDate')">
          <label class="block text-sm font-medium mb-2 text-gray-300">End Date</label>
          <input class="w-full p-2 bg-[#39404b] rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-[#4a9eff] appearance-none"
                 name="end_date"
                 type="date"
                 value="">
        </div>

        <!-- Notes field (TV, Movie, Anime, Manga, Game, Book, Season) -->
        <div x-show="showField('notes')">
          <label class="block text-sm font-medium mb-2 text-gray-300">Notes</label>
          <textarea class="w-full p-2 bg-[#39404b] rounded-md text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-[#4a9eff] appearance-none"
                    rows="4"
                    name="notes"
                    placeholder="Add any notes or comments..."></textarea>
        </div>
      </div>

      <button type="submit"
              class="flex items-center mt-5 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors text-sm cursor-pointer">
        <svg xmlns="http://www.w3.org/2000/svg"
             width="24"
             height="24"
             viewBox="0 0 24 24"
             fill="none"
             stroke="currentColor"
             stroke-width="2"
             stroke-linecap="round"
             stroke-linejoin="round"
             class="w-4 h-4 mr-2">
          <path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"></path>
          <path d="M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7"></path>
          <path d="M7 3v4a1 1 0 0 0 1 1h7"></path>
        </svg>
        Create Entry
      </button>
    </div>
  </form>
</div>

<script>
async function selectSeason(seasonId, seasonText) {
  // Set the season selection
  document.getElementById('parent-season-input').value = seasonText;
  document.getElementById('parent-season-id').value = seasonId;
  document.getElementById('parent-season-results').innerHTML = '';
  
  // Get the next episode number
  try {
    const response = await fetch(`{% url 'get_next_episode_number' %}?season_id=${seasonId}`);
    const data = await response.json();
    
    // Set the episode number input
    const episodeNumberInput = document.querySelector('input[name="episode_number"]');
    if (episodeNumberInput) {
      episodeNumberInput.value = data.next_episode;
    }
  } catch (error) {
    console.error('Error getting next episode number:', error);
  }
}

// YouTube extractor Alpine.js component
function youtubeExtractor() {
  return {
    loading: false,
    channelInfo: null,
    
    async extractMetadata() {
      const url = this.$refs.youtubeInput.value.trim();
      if (!url) return;
      
      this.loading = true;
      this.channelInfo = null;
      
      try {
        const response = await fetch('{% url "youtube_metadata" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: JSON.stringify({ url: url })
        });
        
        const data = await response.json();
        this.loading = false;
        
        if (data.success) {
          const metadata = data.metadata;
          
          // Set channel info for display
          if (metadata.channel_title && metadata.channel_id) {
            this.channelInfo = {
              title: metadata.channel_title,
              id: metadata.channel_id
            };
          }
          
          // Auto-fill form fields
          if (metadata.title) {
            document.querySelector('input[name="title"]').value = metadata.title;
          }
          
          if (metadata.thumbnail) {
            const imageInput = document.querySelector('input[name="image"]');
            imageInput.value = metadata.thumbnail;
            // Trigger image preview update
            const event = new Event('input', { bubbles: true });
            imageInput.dispatchEvent(event);
          }
          
          if (metadata.published_date) {
            document.querySelector('input[name="air_date"]').value = metadata.published_date;
          }
          
          if (metadata.duration_minutes) {
            document.querySelector('input[name="runtime"]').value = metadata.duration_minutes;
          }
          
          console.log('YouTube metadata extracted successfully:', metadata);
        } else {
          alert('Error: ' + data.error);
        }
      } catch (error) {
        this.loading = false;
        console.error('Error extracting YouTube metadata:', error);
        alert('Error extracting YouTube metadata. Please try again.');
      }
    }
  };
}

function youtubeChannelExtractor() {
  return {
    loading: false,
    
    async extractChannelMetadata() {
      const url = this.$refs.channelInput.value.trim();
      if (!url) return;
      
      this.loading = true;
      
      try {
        const response = await fetch('{% url "youtube_metadata" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: JSON.stringify({ url: url, type: 'channel' })
        });
        
        const data = await response.json();
        this.loading = false;
        
        if (data.success) {
          const metadata = data.metadata;
          
          // Auto-fill form fields
          if (metadata.title) {
            document.querySelector('input[name="title"]').value = metadata.title;
          }
          
          if (metadata.thumbnail) {
            const imageInput = document.querySelector('input[name="image"]');
            imageInput.value = metadata.thumbnail;
            // Trigger image preview update
            const event = new Event('input', { bubbles: true });
            imageInput.dispatchEvent(event);
          }
          
          // Store the channel_id in notes field for later use (to fetch videos)
          if (metadata.channel_id) {
            const notesInput = document.querySelector('textarea[name="notes"]');
            if (notesInput) {
              notesInput.value = `YouTube Channel ID: ${metadata.channel_id}`;
            }
          }
          
          console.log('YouTube channel extracted:', metadata.channel_id, metadata.title);
          
          console.log('YouTube channel metadata extracted successfully:', metadata);
        } else {
          alert('Error: ' + data.error);
        }
      } catch (error) {
        this.loading = false;
        console.error('Error extracting YouTube channel metadata:', error);
        alert('Error extracting YouTube channel metadata. Please try again.');
      }
    }
  };
}
</script>

{% endblock content %}
