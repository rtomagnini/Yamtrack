{% load static %}
{% load app_tags %}

<!DOCTYPE html>
<html lang="en" class="scheme-dark bg-[#212529]">
  <head>
    {# Required meta tags #}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="keywords" content="Yamtrack, Media Tracker">
    <meta name="description" content="Search and track media on Yamtrack.">

    <title>
      {% block title %}
        Yamtrack
      {% endblock title %}
    </title>

    {% block extra_head %}
    {% endblock extra_head %}

    <link rel="stylesheet"
          type="text/css"
          href="{% static 'css/main.css' %}{% get_static_file_mtime 'css/main.css' %}">

    <script src="{% static 'js/libraries/htmx-2.0.4.min.js' %}"></script>
    <script defer src="{% static 'js/libraries/alpinejs-3.14.9.min.js' %}"></script>
    <script src="{% static 'js/libraries/lazysizes-5.3.2.min.js' %}" async></script>

    <link rel="apple-touch-icon"
          sizes="180x180"
          href="{% static "favicon/apple-touch-icon.png" %}">
    <link rel="icon"
          type="image/png"
          sizes="32x32"
          href="{% static "favicon/favicon-32x32.png" %}">
    <link rel="icon"
          type="image/png"
          sizes="16x16"
          href="{% static "favicon/favicon-16x16.png" %}">
    <link rel="manifest" href="{% static "favicon/site.webmanifest" %}">
    <link rel="mask-icon"
          href="{% static "favicon/safari-pinned-tab.svg" color="#181a1b" %}">
    <link rel="shortcut icon" href="{% static "favicon/favicon.ico" %}">
    <meta name="msapplication-TileColor" content="#181a1b">
    <meta name="msapplication-config"
          content="{% static "favicon/browserconfig.xml" %}">
    <meta name="theme-color" content="#181a1b">

  </head>

  <body>
    {% block body %}
      {# Main container for the layout #}
      <div class="flex min-h-screen bg-[#212529] text-gray-100"
           x-data="{ isMobileMenuOpen: false }">

        {# Mobile menu overlay #}
        <div x-show="isMobileMenuOpen"
             class="fixed inset-0 bg-black/50 z-30 lg:hidden"
             @click="isMobileMenuOpen = false"></div>

        {# Sidebar #}
        <aside class="fixed top-0 left-0 z-40 h-screen w-64 bg-[#1a1d20] transform transition-transform duration-300 ease-in-out border-r border-[#2c3136] -translate-x-full lg:translate-x-0 lg:sticky"
               :class="isMobileMenuOpen ? 'translate-x-0' : ''">
          <div class="h-16 border-b border-[#2c3136] flex items-center px-6">
            <h1 class="text-2xl font-semibold text-gray-100">Yamtrack</h1>
          </div>
          <nav class="p-4">
            <ul class="space-y-1 mb-6">
              <li>
                <a href="{% url 'home' %}"
                   class="flex items-center space-x-3 px-4 py-2 rounded-md transition-colors duration-200 text-sm {% if request.path == "/" %}text-white bg-[#2c3136]{% else %}text-gray-400 hover:text-white hover:bg-[#23272b]{% endif %}">
                  {% icon 'home' is_active=request.path|str_equals:"/" %}
                  <span>Home</span>
                </a>
              </li>

              {% get_sidebar_media_types user as sidebar_media_types %}
              {% for item in sidebar_media_types %}
                <li>
                  <a href="{% url 'medialist' media_type=item.media_type %}"
                     class="flex items-center space-x-3 px-4 py-2 rounded-md transition-colors duration-200 text-sm {% if media_type == item.media_type %}text-white bg-[#2c3136]{% else %}text-gray-400 hover:text-white hover:bg-[#23272b]{% endif %}">
                    {% icon item.media_type is_active=media_type|str_equals:item.media_type %}
                    <span>{{ item.display_name }}</span>
                  </a>
                </li>
              {% endfor %}
            </ul>

            <div class="border-t border-[#2c3136] pt-4">
              <ul class="space-y-1">
                {% url 'create_entry' as create_entry_url %}
                <li>
                  <a href="{{ create_entry_url }}"
                     class="flex items-center space-x-3 px-4 py-2 rounded-md transition-colors duration-200 text-sm {% if request.path == create_entry_url %}text-white bg-[#2c3136]{% else %}text-gray-400 hover:text-white hover:bg-[#23272b]{% endif %}">
                    {% icon 'create' is_active=request.path|str_equals:create_entry_url %}
                    <span>Create Custom</span>
                  </a>
                </li>

                {% url 'statistics' as statistics_url %}
                <li>
                  <a href="{{ statistics_url }}"
                     class="flex items-center space-x-3 px-4 py-2 rounded-md transition-colors duration-200 text-sm {% if request.path == statistics_url %}text-white bg-[#2c3136]{% else %}text-gray-400 hover:text-white hover:bg-[#23272b]{% endif %}">
                    {% icon 'statistics' is_active=request.path|str_equals:statistics_url %}
                    <span>Statistics</span>
                  </a>
                </li>

                {% url 'lists' as lists_url %}
                <li>
                  <a href="{{ lists_url }}"
                     class="flex items-center space-x-3 px-4 py-2 rounded-md transition-colors duration-200 text-sm {% if request.path == lists_url %}text-white bg-[#2c3136]{% else %}text-gray-400 hover:text-white hover:bg-[#23272b]{% endif %}">
                    {% icon 'lists' is_active=request.path|str_equals:lists_url %}
                    <span>Lists</span>
                  </a>
                </li>

                {% url 'release_calendar' as calendar_url %}
                <li>
                  <a href="{{ calendar_url }}"
                     class="flex items-center space-x-3 px-4 py-2 rounded-md transition-colors duration-200 text-sm {% if request.path == calendar_url %}text-white bg-[#2c3136]{% else %}text-gray-400 hover:text-white hover:bg-[#23272b]{% endif %}">
                    {% icon 'calendar' is_active=request.path|str_equals:calendar_url %}
                    <span>Calendar</span>
                  </a>
                </li>

                {% url 'account' as account_url %}
                {% url 'notifications' as notifications_url %}
                {% url 'sidebar' as sidebar_url %}
                {% url 'integrations' as integrations_url %}
                {% url 'import_data' as import_url %}
                {% url 'export_data' as export_url %}
                <li>
                  <a href="{{ account_url }}"
                     class="flex items-center space-x-3 px-4 py-2 rounded-md transition-colors duration-200 text-sm {% if request.path == account_url or request.path == notifications_url or request.path == sidebar_url or request.path == integrations_url or request.path == import_url or request.path == export_url %}text-white bg-[#2c3136]{% else %}text-gray-400 hover:text-white hover:bg-[#23272b]{% endif %}">
                    {% if request.path == account_url or request.path == notifications_url or request.path == sidebar_url or request.path == integrations_url or request.path == import_url or request.path == export_url %}
                      {% icon 'settings' is_active=True %}
                    {% else %}
                      {% icon 'settings' is_active=False %}
                    {% endif %}
                    <span>Settings</span>
                  </a>
                </li>
              </ul>
            </div>
          </nav>
          <div class="absolute bottom-4 left-4 right-4">
            <form method="post" action="{% url 'account_logout' %}" class="w-full">
              {% csrf_token %}
              <button type="submit"
                      class="w-full flex items-center space-x-3 px-4 py-2 rounded-md text-gray-400 hover:bg-[#23272b] hover:text-white transition-colors duration-200 text-sm cursor-pointer">
                {% icon 'logout' is_active=False %}
                <span>Logout</span>
              </button>
            </form>
          </div>
        </aside>

        {# Main content #}
        <div class="flex-1 flex flex-col min-h-screen">
          {# Top bar #}
          <div class="sticky top-0 z-10 bg-[#1a1d20] border-b border-[#2c3136] shadow-md">
            <div class="container mx-auto px-4">
              <div class="flex items-center justify-between lg:justify-center h-16">
                {# Mobile: sidebar toggle button #}
                <button @click="isMobileMenuOpen = !isMobileMenuOpen"
                        class="lg:hidden pe-3 text-gray-400 hover:text-white transition-colors duration-200">
                  <svg xmlns="http://www.w3.org/2000/svg"
                       width="24"
                       height="24"
                       viewBox="0 0 24 24"
                       fill="none"
                       stroke="currentColor"
                       stroke-width="2"
                       stroke-linecap="round"
                       stroke-linejoin="round"
                       class="w-6 h-6">
                    <line x1="4" x2="20" y1="12" y2="12"></line>
                    <line x1="4" x2="20" y1="6" y2="6"></line>
                    <line x1="4" x2="20" y1="18" y2="18"></line>
                  </svg>
                </button>

                {# Define search type from current media type (if it exists) or last search type #}
                {% if media_type == MediaTypes.SEASON.value %}
                  {% firstof MediaTypes.TV.value as search_type %}
                {% else %}
                  {% firstof media_type user.last_search_type as search_type %}
                {% endif %}

                {# Search bar #}
                <div class="relative w-full max-w-2xl">
                  <form method="get"
                        action="{% url 'search' %}"
                        x-data=" { isOpen: false, selectedType: { display: '{{ search_type|media_type_readable_plural }}', value: '{{ search_type }}' }, mediaTypes: {% get_search_media_types user as search_types %}{{ search_types }}, getPlaceholder() { return `Search ${this.selectedType.display.toLowerCase()}...` } }">
                    <div class="flex">
                      <div class="relative flex-grow">
                        {# Search input #}
                        <input type="search"
                               name="q"
                               value="{{ request.GET.q }}"
                               :placeholder="getPlaceholder()"
                               class="w-full py-2 pl-10 pr-4 text-sm text-gray-300 bg-[#272c31] rounded-l-md focus:outline-none focus:ring-2 focus:ring-[#4a9eff] focus:ring-inset placeholder-gray-500">
                        <button type="submit"
                                class="absolute left-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white transition-colors duration-200 focus:outline-none cursor-pointer">
                          <svg xmlns="http://www.w3.org/2000/svg"
                               width="24"
                               height="24"
                               viewBox="0 0 24 24"
                               fill="none"
                               stroke="currentColor"
                               stroke-width="2"
                               stroke-linecap="round"
                               stroke-linejoin="round"
                               class="w-5 h-5">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.3-4.3"></path>
                          </svg>
                        </button>
                      </div>

                      <input type="hidden" name="media_type" :value="selectedType.value">

                      {# Media type dropdown #}
                      <button type="button"
                              @click="isOpen = !isOpen"
                              @click.away="isOpen = false"
                              class="flex items-center justify-between w-32 px-4 py-2 text-sm text-gray-300 bg-[#272c31] rounded-r-md focus:outline-none focus:ring-2 focus:ring-[#4a9eff] focus:ring-inset hover:bg-[#2a2e33] transition-colors duration-200 cursor-pointer">
                        <span x-text="selectedType.display"></span>
                        <svg class="w-4 h-4 ml-2"
                             fill="none"
                             stroke="currentColor"
                             viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                      </button>
                      <ul x-cloak
                          x-show="isOpen"
                          @keydown.escape.window="isOpen = false"
                          x-transition:enter="transition ease-out duration-100"
                          x-transition:enter-start="transform opacity-0 scale-95"
                          x-transition:enter-end="transform opacity-100 scale-100"
                          x-transition:leave="transition ease-in duration-75"
                          x-transition:leave-start="transform opacity-100 scale-100"
                          x-transition:leave-end="transform opacity-0 scale-95"
                          class="absolute z-20 py-1 mt-12 overflow-auto text-sm text-gray-300 bg-[#2a2e33] rounded-md shadow-lg right-0 w-[128px]">
                        <template x-for="type in mediaTypes" :key="type.value">
                          <li @click="selectedType = type; isOpen = false"
                              class="px-4 py-2 cursor-pointer hover:bg-[#343a40] transition duration-150 ease-in-out"
                              x-text="type.display"></li>
                        </template>
                      </ul>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <main class="flex-1 relative bg-[#212529]">
            <div class="container mx-auto px-8 py-12">
              {% block content %}
              {% endblock content %}
            </div>
          </main>
        </div>
      </div>
    {% endblock body %}

    {% if messages %}
      <div class="fixed top-24 right-0 left-0 {% block messages_sidebar_offset %}lg:left-64{% endblock messages_sidebar_offset %} z-50 flex justify-center pointer-events-none">
        <div class="w-full max-w-xl px-4 space-y-2 pointer-events-auto">
          {% for message in messages %}
            {# djlint:off #}
            <div class="flex items-center gap-2 rounded-md border px-3 py-2 shadow-lg text-white toast-{{ message.tags }} opacity-0"
              x-data="{ 
                  init() { 
                    // Start entrance animation after a tiny delay
                    setTimeout(() => this.$el.classList.add('opacity-100', 'transform-none'), 10);
                    this.$el.classList.add('transition-all', 'duration-300', 'ease-out', 'transform', 'translate-y-[-1rem]');
          
                    {% if message.tags not in 'warning,error' %}
                      // Auto-dismiss non-critical messages
                      setTimeout(() => this.$el.remove(), 5000);
                    {% endif %}
                  }
              }">

              {% if message.tags == 'success' %}
                <svg xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="w-4 h-4 text-emerald-300 flex-shrink-0">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                  <path d="m9 11 3 3L22 4"></path>
                </svg>
              {% elif message.tags == 'warning' %}
                <!-- Warning SVG -->
                <svg xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="w-4 h-4 text-amber-300 flex-shrink-0">
                  <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3"></path>
                  <path d="M12 9v4"></path>
                  <path d="M12 17h.01"></path>
                </svg>
              {% elif message.tags == 'error' %}
                <!-- Error SVG -->
                <svg xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="w-4 h-4 text-red-300 flex-shrink-0">
                  <circle cx="12" cy="12" r="10"></circle><line x1="12" x2="12" y1="8" y2="12"></line><line x1="12" x2="12.01" y1="16" y2="16"></line>
                </svg>
              {% elif message.tags == "info" %}
                <!-- Info SVG -->
                <svg xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="w-4 h-4 text-indigo-300 flex-shrink-0">
                  <circle cx="12" cy="12" r="10"></circle>
                  <path d="M12 16v-4"></path>
                  <path d="M12 8h.01"></path>
                </svg>
              {% endif %}

              <p class="text-sm font-medium flex-1">{{ message }}</p>
              <button class="text-current opacity-70 hover:opacity-100 transition-opacity cursor-pointer"
                      @click="$el.parentElement.remove()">
                <svg xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round">
                  <path d="M18 6 6 18"></path>
                  <path d="m6 6 12 12"></path>
                </svg>
              </button>
            </div>
            {# djlint:on #}
          {% endfor %}
        </div>
      </div>
    {% endif %}

    {% block js %}
    {% endblock js %}
  </body>
</html>
